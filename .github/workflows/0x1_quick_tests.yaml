# Fork: https://github.com/shutingrz/busybox-static-binaries-fat/tree/main
name: 0x1 âž¼ Quick Tests

on:
  workflow_dispatch:

env:
  GITHUB_TOKEN: "${{ secrets.STATIC_BINARIES_RELEASER }}"

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          path: main

          
      - name: Install upX
        #if: env.versions_same != 'true'
        run: |
          cd $(mktemp -d) && curl -qfLJO "$(curl -s https://api.github.com/repos/upx/upx/releases/latest | jq -r '.assets[].browser_download_url' | grep -i 'amd64_linux')"
          find . -type f -name '*tar*' -exec tar -xvf {} \;
          sudo find . -type f -name 'upx' -exec mv {} "$(which upx)" \;  
        continue-on-error: false
        
      - name: Update README.md
        #if: env.versions_same != 'true'
        run: |
           cd "$GITHUB_WORKSPACE/main"
           cat ./tailscale/INFO.md > ./tailscale/README.md
           echo -e "" >> ./tailscale/README.md 
           echo '---' >> ./tailscale/README.md
           echo '```console' >> ./tailscale/README.md
           echo -e "" >> ./tailscale/README.md
           echo -e "--> METADATA" >> ./tailscale/README.md
           /bin/bash -c 'PS4="$ ";file ./tailscale/tailscale* | grep -v '.txt' | grep -v '.service' | grep -v '.defaults' ' &>> ./tailscale/README.md
           echo -e "" >> ./tailscale/README.md
           echo -e "--> SHA256SUM" >> ./tailscale/README.md
           /bin/bash -c 'PS4="$ ";sha256sum ./tailscale/tailscale* | grep -v '.txt' | grep -v '.service' | grep -v '.defaults' ' &>> ./tailscale/README.md   
           echo -e '```\n' >> ./tailscale/README.md
           echo -e "" >> ./tailscale/README.md
           echo '---' >> ./tailscale/README.md
           echo -e "" >> ./tailscale/README.md
           echo '- #### Sizes' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md
           echo '```console' >> ./tailscale/README.md       
           /bin/bash -c 'PS4="$ ";ls -lh ./tailscale/tail* | grep -v '.txt' | grep -v '.service' | grep -v '.defaults' | awk "{print \$5, \$9}" | column -t' &>> ./tailscale/README.md
           echo '```' >> ./tailscale/README.md   
           echo -e "" >> ./tailscale/README.md 
           echo '---' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md 
           echo '- #### UPX' >> ./tailscale/README.md 
           echo '```console' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md
           #/bin/bash -c 'PS4="$ "; find ./tailscale/ -type f -name '*upx' -exec upx --no-progress -q -t {} \; -exec upx --no-progress -q -l {} \; | awk '/^testing/ || /->/ { print }' ' &>> ./tailscale/README.md   
           {
              /bin/bash -c 'PS4="$ "; find ./tailscale/ -type f -name "*upx" -exec upx --no-progress -q -t {} \; -exec upx --no-progress -q -l {} \; | awk "/^testing/ || /->/ { print }" 2>&1'
           } >> ./tailscale/README.md
           echo -e "" >> ./tailscale/README.md 
           echo '```' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md
           echo '---' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md 
           echo '- #### Version' >> ./tailscale/README.md 
           echo '```console' >> ./tailscale/README.md 
           /bin/bash -c 'PS4="$ "; set -x; ./tailscale/tailscale_amd_x86_64_Linux --version' &>> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md
           /bin/bash -c 'PS4="$ "; ./tailscale/tailscale_amd_x86_64_Linux -h' &>> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md
           /bin/bash -c 'PS4="$ "; set -x; ./tailscale/tailscaled_amd_x86_64_Linux -version' &>> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md
           /bin/bash -c 'PS4="$ "; ./tailscale/tailscaled_amd_x86_64_Linux -h' &>> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md 
           echo '```' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md        
           echo '---' >> ./tailscale/README.md 
           echo -e "" >> ./tailscale/README.md 
        working-directory: main
        continue-on-error: true


   #Commit & Push     
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: ./main        
          commit_user_name: Azathothas # defaults to "github-actions[bot]"
          commit_user_email: AjamX101@gmail.com # defaults to "41898282+github-actions[bot]@users.noreply.github.com"
          commit_message: "Build || Fetch Tailscale Binaries <-- ${{ env.VERSION }}"
          #push_options: '--force'          
